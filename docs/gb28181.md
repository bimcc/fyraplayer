# FyraPlayer GB28181 前端支持方案

## 目标与范围
- 在不破坏现有 Tech/管线的前提下，新增 `gb28181` 源/Tech，播放 GB28181/PS 流（H.264/H.265 + AAC/PCMA/PCMU/Opus）。
- 数据面主走 WebSocket/WebTransport，沿用 `ws-raw` 渲染栈；必要时回退 MSE/flv.js。
- 信令面暴露 invite/bye/ptz/query 等控制，遵守现有 middleware/Tech 抽象。

## 现有基础（2025-12-30）
- `tech-ws-raw` 已作为主路径：WS → `wsRaw/pipeline` → `demuxer`(flv/ts/annexb) → `jitterBuffer` → WebCodecs/WASM → `renderer`，失败走 MSE fallback。
- 音频仅 AAC/Opus（依赖 `AudioDecoder`），无 G.711；视频仅 H.264；`demuxer` 无 PS。
- `types.ts` 尚无 `gb28181` Source/Tech。

## 后端接口假设
- 后端完成：SIP/SDP → PS 解复用 → RTP depacketize → 转封装（推荐 AnnexB 或 MPEG-TS；如需可保留自定义帧头） → 数据 WS/WT。
- 控制 API：`invite` 返回 data WS/WT URL、流描述（编解码、分辨率、时钟、VPS/SPS/PPS、ASC/OpusHead）；`bye`、`ptz`、`query`、`keepalive`。
- 可选：在 data WS 内传递心跳/丢包/时钟基（用于前端校时）。

## 数据通道格式（建议）
- 首包：JSON/TLV，含 `codecVideo`, `codecAudio`, `width/height`, `sampleRate/channels`, `ptsBase`, `sps/pps/vps/asc/opusHead`。
- 视频帧：`[u8 type=1][u8 flags bit0=key][u32be tsMs][u32be len] + AnnexB`（H.264/265）。首个 I 帧需附 VPS/SPS/PPS 若未预送。
- 音频帧：`[u8 type=2][u8 flags bit0=config][u32be tsMs][u32be len] + ES`（AAC raw、PCMA、PCMU、Opus）。
- 控制/统计：`type=3` 预留（buffer、loss、rtt），WS/WT 同构，可选压缩。
- 若后端直接输出 FLV/TS，可在 Source 标注 `format: 'flv'|'ts'` 走现有 demux。

## Source/Tech 设计
- `types.ts`：
  - `TechName` 增 `gb28181`。
  - 新增 `Gb28181Source`：
    ```ts
    type Gb28181Source = BaseSourceFields & {
      type: 'gb28181';
      url: string;                // data WS/WT
      control: { invite: string; bye: string; ptz?: string; query?: string; keepalive?: string };
      gb: { deviceId: string; channelId: string; ssrc?: string; transport?: 'udp'|'tcp'; expires?: number };
      format?: 'annexb' | 'ts';   // 默认 annexb
      codecHints?: { video?: 'h264'|'h265'; audio?: 'aac'|'pcma'|'pcmu'|'opus'; width?: number; height?: number; sampleRate?: number; channels?: number };
      heartbeatMs?: number;
      decoderUrl?: string;
      audioOptional?: boolean;    // 默认 true
      preferTech?: 'gb28181';
    };
    ```
- `player.ts` 注册新 `Gb28181Tech`，透出便捷 `player.gb?.control(action, payload)`（内部走 control middleware）。

## Tech 行为（`tech-gb28181.ts`）
- `load`：先调用 `invite` 获得 data URL + streamInfo，合并到 Source，随后实例化 `WsRawPipeline`（传入 `format`、`decoderUrl`、`codecHints`）。
- 事件透传：`onReady/onError/onNetwork/onFallback/onMetadata` 与 `ws-raw` 保持一致。
- 控制面：`invoke('gb:invite'|'gb:bye'|'gb:ptz'|'gb:query'|'gb:keepalive')`，失败时按 `ReconnectPolicy` 重邀；支持 data WS 心跳（兼容现有 heartbeatMs）。
- 状态：记录 callId/ssrc/streamId，供 stats/network 事件上报。

## 管线改动（`wsRaw/pipeline`）
- 输入解析：在 `wsRaw` 前添加轻量 “GBChunkReader”（或在 pipeline 内新分支），解析自定义帧头后输出 `DemuxedFrame`，`format: 'annexb'|'ts'` 直接复用 demux 现有逻辑。
- 编码标签：为 `DemuxedFrame` 添加 `codec` 字段（h264/h265/aac/pcma/pcmu/opus），驱动对应解码路径。
- 时钟：使用首包 `ptsBase` + 每帧 tsMs；保持 `jitterBuffer` + `catchUp` 策略。
- 元数据：如果 `format='ts'` 继续用 SEI/KLV 回调；否则允许在 `type=3` 携带 TLV 并直接触发 `onMetadata`。

## 编解码支持
- 视频：
  - WebCodecs：在 `webcodecsDecoder` 允许 `hvc1/hev1`（受 `webCodecs.allowH265` 开关）。
  - WASM：`defaultDecoders` 增 H.265 备选（如 h265bsd/ffmpeg wasm）；pipeline 在 H.265 且 WebCodecs 不可用时使用。
- 音频：
  - AAC/Opus：保留现有 `AudioDecoder` 路径，缺失时触发 `audioOptional` 逻辑。
  - G.711 A/μ：新增解码分支（优先 `AudioDecoder` codec `pcma`/`pcmu`，否则 ScriptProcessor/AudioWorklet + 查表解码）。

## 兼容与回退
- 不影响现有源/Tech；`gb28181` 失败按 `techOrder` 回退。
- Safari/iOS 仍可触发 MSE fallback（flv/ts）；音频失败且 `audioOptional: true` 时静音播放。

## 实施阶段
1) 贯通 MVP：新增 Source/Tech，支持 AnnexB H.264 + AAC/PCMA/PCMU，后端首包给 SPS/PPS/ASC；前端走 `wsRaw` 流程可播放。
2) 能力补齐：WebCodecs H.265 + WASM 兜底；Opus 兜底；网络事件扩展（invite/reinvite/keepalive/loss）。
3) 体验与稳健：PTZ/query UI 插件、重邀/心跳策略、TS 元数据/报警透传、可选 WebTransport、若后端无法转封装再补 `ps-demuxer`。

## 验证清单
- H.264/H.265 + AAC/PCMA/PCMU/Opus 各一条流可播；无音频时静音不崩。
- WebCodecs 不可用时，H.264/H.265 能走 WASM；音频不可用时按 `audioOptional` 行为。
- invite/bye/ptz/query/keepalive API 正常；断线后按策略重邀；心跳丢失能上报 network 事件。
- TS 路径：SEI/KLV 探测/抽取事件可达；AnnexB 路径：自定义 metadata 能透传。
- fallback：视频解码错误/音频强依赖失败能自动走 MSE 或触发错误上报。
